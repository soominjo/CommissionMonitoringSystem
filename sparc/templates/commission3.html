{% extends "index.html" %}

{% block content %}

{% load static %}
{% load humanize %}
{% load custom_filters %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor-Agent Commission Slip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            /* Hide everything except the printable content */
            body * {
                visibility: hidden;
            }
            
            #printable-content, #printable-content * {
                visibility: visible;
            }
            
            #printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            /* Hide specific elements */
            .no-print, 
            nav, 
            footer, 
            #print-button,
            .back-button {
                display: none !important;
            }

            /* Ensure white background */
            #printable-content {
                background-color: white !important;
                padding: 20px;
            }
        }

        /* Style for the buttons container */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .print-button {
            background-color: #22c55e;
            color: white;
        }


        .print-button:hover {
            background-color: #16a34a;
        }


        /* Add specific styling for content */
        #printable-content {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        #printable-content table {
            width: 100% !important;
            margin-bottom: 20px;
            page-break-inside: avoid;
            font-size: 12px;
        }

        #printable-content td,
        #printable-content th {
            padding: 8px;
            white-space: nowrap;
        }

        /* Page settings */
        @page {
            margin: 15mm;
        }

        /* Ensure table cells don't wrap unnecessarily */
        .commission-table {
            border-collapse: collapse;
            width: 100%;
        }

        .commission-table td,
        .commission-table th {
            white-space: nowrap;
            padding: 8px 12px;
            border: 1px solid #ddd;
        }

        /* Adjust font sizes for print */
        @media print {
            body {
                font-size: 12px;
            }
            h2 {
                font-size: 18px;
            }
            .text-sm {
                font-size: 10px;
            }
        }
    </style>
</head>

<!-- Back Button - No Print -->
<div class="flex justify-end mb-4">
    <a href="{% url 'commission_history' %}" 
       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 shadow-sm">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Back to History
    </a>
</div>

<!-- Printable Content -->
<div id="printable-content" class="bg-white shadow-lg rounded-lg p-8 w-[900px] mx-auto border-4 border-blue-500" data-slip-id="{{ slip.id }}" data-slip-type="commission3" data-has-signature="{% if slip.signature %}true{% else %}false{% endif %}">
    <div class="flex items-center justify-center text-center border-b pb-4 mb-4">
        <img src="{% static 'media/LOGO.png' %}" alt="Company Logo" class="w-20 h-20 object-contain mr-4"> 
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Inner SPARC Realty Corporation</h2>
            <p class="text-sm text-gray-600">
                Main Office: Block 26 Lot 4 Phase 3 Avida Residences Sta. Catalina, Salawag, Dasmariñas, Cavite 4114 <br> 
                63917-853-4875/63999-994-3304/(046)458 0706 <br>
                Inner SPARC Realty Services
            </p>
            <p class="text-2xl text-blue-700 text-right">
                <STRONG> {{ slip.date }} </STRONG>
            </p>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 text-gray-700">
        <p><strong>Sales Agent:</strong> {{ slip.sales_agent_name }}</p>
        {% if slip.supervisor_name %}
            <p><strong>Sales Supervisor:</strong> {{ slip.supervisor_name }}</p>
        {% endif %}
        {% if slip.manager_name %}
            <p><strong>Sales Manager:</strong> {{ slip.manager_name }}</p>
        {% endif %}
        <p><strong>Buyer:</strong> {{ slip.buyer_name }}</p>
        <p><strong>Project Name:</strong> {{ slip.project_name }}</p>
        <p><strong>Unit ID:</strong> {{ slip.unit_id }}</p>
        <p><strong>Commission Rate:</strong> {{ display_commission_rate|floatformat:2 }}%</p>
        <p><strong>Total Selling Price:</strong> ₱{{ slip.total_selling_price|floatformat:0|intcomma }}</p>    
        {% with cash_advance_after_tax=slip.cash_advance|multiply:90 %}
        <p><strong>Cash Advance (less 10% tax):</strong> ₱{{ cash_advance_after_tax|floatformat:0|intcomma }}</p>
        {% endwith %}
        
        <p><strong>Particulars:</strong> {{ display_particulars }}</p>
       
        {% for detail in details %}
        {% if forloop.first %}
            {% if detail.particulars == 'PARTIAL COMM' %}
                <p><strong>Percentage:</strong> 
                    {% if detail.percentage_of_particulars %}
                        {{ detail.percentage_of_particulars|floatformat:0 }}%
                    {% else %}
                        {{ detail.partial_percentage|floatformat:0 }}%
                    {% endif %}
                </p>
            {% elif detail.particulars == 'FULL COMM' %}
                <p><strong>Percentage:</strong> 
                    {% if detail.percentage_of_particulars %}
                        {{ detail.percentage_of_particulars|floatformat:0 }}%
                    {% else %}
                        100%
                    {% endif %}
                </p>
            {% endif %}
            {% if detail.particulars == 'INCENTIVES' %}
                <p><strong>Additional Incentive:</strong> ₱{{ slip.incentive_amount|floatformat:0|intcomma }}</p>
            {% endif %}
        {% endif %}
        {% endfor %}
    
        <!-- VAT and Tax Information -->
        {% if slip.vat_rate %}
        <p><strong>VAT Rate:</strong> {{ slip.vat_rate|floatformat:2 }}%</p>
        {% endif %}
        {% if slip.withholding_tax_percentage %}
        <p><strong>Withholding Tax Rate:</strong> {{ slip.withholding_tax_percentage|floatformat:2 }}%</p>
        {% endif %}
        
    </div>
    
    <!-- VAT-Compliant Commission Calculation Display -->
    {% if slip.vat_rate or slip.withholding_tax_percentage %}
    <div class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
        <h3 class="text-lg font-medium text-gray-700 mb-4 flex items-center">
            <i class="fas fa-calculator mr-2 text-blue-500"></i>VAT-Compliant Commission Calculation
        </h3>
        
        <!-- Step-by-Step Calculation Display -->
        <div class="space-y-2 text-sm">
            <div class="flex justify-between items-center py-1 border-b border-gray-200">
                <span class="text-gray-700">1. Total Commission Rate:</span>
                <span class="font-semibold text-gray-900">{{ display_commission_rate|floatformat:2 }}%</span>
            </div>
            
            <div class="flex justify-between items-center py-1 border-b border-gray-200">
                <span class="text-gray-700">2. Total Gross Commission:</span>
                <span class="font-semibold text-gray-900">₱{{ total_gross_commission|floatformat:2|intcomma }}</span>
            </div>
            
            <div class="flex justify-between items-center py-1 border-b border-gray-200">
                <span class="text-gray-700">3. VATABLE Amount:</span>
                <span class="font-semibold text-gray-900">₱{{ vatable_amount|floatformat:2|intcomma }}</span>
            </div>
            
            <div class="flex justify-between items-center py-1 border-b border-gray-200">
                <span class="text-gray-700">4. Total Tax Deductions:</span>
                <span class="font-semibold text-gray-900">₱{{ total_tax_deductions|floatformat:2|intcomma }}</span>
            </div>
        </div>
        
        <!-- Final Net Commission -->
        <div class="border-t-2 border-gray-300 pt-3 mt-3">
            <div class="flex justify-between items-center">
                <span class="text-lg font-semibold text-gray-800">NET COMMISSION (Final Payable Amount):</span>
                <span class="text-xl font-bold text-gray-900">₱{{ final_net_commission|floatformat:2|intcomma }}</span>
            </div>
        </div>
    </div>
    {% endif %}
    
    <table class="w-full mt-6 border border-gray-300 text-sm text-gray-700 text-center">
        <thead class="bg-blue-500 text-white text-center">
            <tr>
                <th class="p-2 border">Position</th>
                <th class="p-2 border">Particulars</th>
                <th class="p-2 border">Commission Rate</th>
                <th class="p-2 border">Gross Commission</th>
                <th class="p-2 border">VAT & EWT</th>
                <th class="p-2 border">Net Commission</th>
            </tr>
        </thead>
        <tbody>
            {% for detail in details %}
            <tr>
                <td class="p-2 border">
                    {% if detail.agent_name == slip.sales_agent_name %}
                        Sales Agent
                    {% elif detail.agent_name == slip.supervisor_name %}
                        Sales Supervisor
                    {% elif detail.agent_name == slip.manager_name %}
                        Sales Manager
                    {% else %}
                        {{ detail.role }}
                    {% endif %}
                </td>
                <td class="p-2 border">
                    {% if detail.particulars == 'PARTIAL COMM' %}
                        {% if detail.percentage_of_particulars %}
                            {{ detail.percentage_of_particulars|floatformat:0 }}% COMM
                        {% else %}
                            {{ detail.partial_percentage|floatformat:0 }}% COMM
                        {% endif %}
                    {% elif detail.particulars == 'INCENTIVES' %}
                        INCENTIVES
                    {% else %}
                        {% if detail.percentage_of_particulars %}
                            {{ detail.percentage_of_particulars|floatformat:0 }}% COMM
                        {% else %}
                            100% COMM
                        {% endif %}
                    {% endif %}
                </td>
                <td class="p-2 border text-center">{{ detail.commission_rate|floatformat:2 }}%</td>
                <td class="p-2 border">
                    <div class="editable-gross-commission" data-detail-id="{{ detail.id }}" data-commission-type="commission3">
                        <span class="gross-commission-display">₱{{ detail.gross_commission|floatformat:2|intcomma }}</span>
                        {% if user.is_superuser %}
                        <input type="number" 
                               class="gross-commission-input hidden w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               value="{{ detail.gross_commission|floatformat:2 }}" 
                               step="0.01" 
                               min="0">
                        <button class="edit-gross-commission-btn text-blue-600 hover:text-blue-800 ml-2 text-xs" title="Edit Gross Commission">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
                <td class="p-2 border">
                    <span class="withholding-tax-display" data-detail-id="{{ detail.id }}">₱{{ detail.withholding_tax|floatformat:2|intcomma }}</span>
                </td>
                <td class="p-2 border">
                    <span class="net-commission-display" data-detail-id="{{ detail.id }}">₱{{ detail.net_commission|floatformat:2|intcomma }}</span>
                </td>
            </tr>
            {% endfor %}
            
            {% if user.is_staff or user.is_superuser or user.profile.role == 'Sales Manager' or user.profile.role == 'Sales Supervisor' %}
            <tr class="bg-gray-50 font-semibold">
                <td colspan="3" class="p-2 border text-right">Total:</td>
                <td class="p-2 border">
                    <div class="editable-total-gross-commission inline-flex items-center justify-center">
                        <span class="total-gross-commission-display">₱{{ total_gross|floatformat:2|intcomma }}</span>
                        {% if user.is_superuser %}
                        <input type="number" 
                               class="total-gross-commission-input hidden w-32 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center font-bold" 
                               value="{{ total_gross|floatformat:2 }}" 
                               step="0.01" 
                               min="0">
                        <button class="edit-total-gross-commission-btn text-blue-600 hover:text-blue-800 ml-2 text-xs" title="Edit Total Gross Commission">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
                <td class="p-2 border total-tax-display">₱{{ total_tax|floatformat:2|intcomma }}</td>
                <td class="p-2 border total-net-display">₱{{ total_net|floatformat:2|intcomma }}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Signatures -->
    <div class="mt-6 text-center text-gray-700 text-sm">
        <p>Prepared by: <span class="font-semibold">Shiela Mae F. Fajutagana</span> (Accounting Staff)</p>
        <p>Checked by: <span class="font-semibold">Gabriel V. Libacao Jr.</span> (Chief Executive Officer)</p>
        <p>Received by: <span class="font-semibold">{{ slip.sales_agent_name }}</span> (Agent)</p>
        {% if slip.supervisor_name %}<p>Received by: <span class="font-semibold">{{ slip.supervisor_name }}</span> (Supervisor)</p>{% endif %}

        <!-- Signature Area -->
        <div class="mt-6">
            <div id="signature-display" class="mb-2" {% if not slip.signature %}style="display: none;"{% endif %}>
                <img id="signature-image" src="{% if slip.signature %}{{ slip.signature.url }}{% endif %}" alt="Signature" class="mx-auto max-h-16 border border-gray-300 rounded">
                <p class="text-green-600 font-semibold mt-1">SIGNED</p>
            </div>
            <div id="signature-placeholder" class="border-b border-gray-400 pb-2 mb-2" {% if slip.signature %}style="display: none;"{% endif %}>
                <p class="text-gray-400">______________________________________</p>
            </div>
            <p>Signature Over Printed Name</p>
        </div>

        <p class="mt-4 text-gray-600 italic">Thank you for your trust and confidence in our business.</p>
    </div>
</div>


<!-- Action Buttons - No Print -->
<div class="mt-8 flex flex-wrap justify-center items-center gap-3 sm:gap-4 no-print">
    {% if not edit_mode %}
        
        <button onclick="printContent()" class="inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-all duration-200 text-sm sm:text-base">
            <span class="hidden sm:inline">Print Commission Slip</span>
            <span class="sm:hidden">Print</span>
        </button>
        
        <!-- Signature Upload Button -->
        <div class="mt-2">
            <input type="file" id="signature-upload" accept="image/*" style="display: none;" onchange="handleSignatureUpload(event)">
            <button type="button" id="attach-signature-btn" onclick="document.getElementById('signature-upload').click()" class="inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-all duration-200 text-sm sm:text-base cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
                <span class="hidden sm:inline">Attach Signature</span>
                <span class="sm:hidden">Sign</span>
            </button>
            <button type="button" id="save-signature-btn" onclick="saveSignature()" class="inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-all duration-200 text-sm sm:text-base" style="display: none;">
                Save Signature
            </button>
            <button type="button" id="clear-signature-btn" onclick="clearSignature()" class="inline-flex items-center justify-center px-4 py-2 sm:px-5 sm:py-2.5 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-all duration-200 text-sm sm:text-base" style="display: none;">
                 Clear
            </button>
        </div>
        
    {% else %}
        <button type="submit" class="action-button print-button">Save Changes</button>
    {% endif %}
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function printContent() {
        window.print();
    }

    function handleSignatureUpload(event) {
        const file = event.target.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File size must be less than 5MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('signature-image').src = e.target.result;
                document.getElementById('signature-display').style.display = 'block';
                document.getElementById('signature-placeholder').style.display = 'none';
                document.getElementById('save-signature-btn').style.display = 'inline-flex';
                document.getElementById('clear-signature-btn').style.display = 'inline-flex';
                document.getElementById('attach-signature-btn').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }

    function saveSignature() {
        const signatureData = document.getElementById('signature-image').src;
        const container = document.getElementById('printable-content');
        const slipId = container.dataset.slipId;
        const slipType = container.dataset.slipType;

        fetch('/save-signature/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                'slip_id': slipId,
                'slip_type': slipType,
                'signature': signatureData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Signature saved successfully!');
                window.location.reload();
            } else {
                alert('Error saving signature: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
        });
    }
    
    function clearSignature() {
        document.getElementById('signature-display').style.display = 'none';
        document.getElementById('signature-placeholder').style.display = 'block';
        document.getElementById('save-signature-btn').style.display = 'none';
        document.getElementById('clear-signature-btn').style.display = 'none';
        document.getElementById('attach-signature-btn').style.display = 'inline-flex';
        document.getElementById('signature-upload').value = '';
    }
    
    // Gross Commission Editing Functions
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-PH', {
            style: 'currency',
            currency: 'PHP',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount).replace('PHP', '₱');
    }

    function updateGrossCommission(detailId, newGrossCommission, commissionType) {
        const csrftoken = getCookie('csrftoken');
        
        console.log('Making AJAX request with:', {
            detail_id: detailId,
            gross_commission: newGrossCommission,
            commission_type: commissionType
        });
        
        fetch('/update-gross-commission/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                'detail_id': detailId,
                'gross_commission': newGrossCommission,
                'commission_type': commissionType
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                // Update the display values
                const grossDisplay = document.querySelector(`[data-detail-id="${detailId}"] .gross-commission-display`);
                const taxDisplay = document.querySelector(`.withholding-tax-display[data-detail-id="${detailId}"]`);
                const netDisplay = document.querySelector(`.net-commission-display[data-detail-id="${detailId}"]`);
                
                if (grossDisplay) grossDisplay.textContent = formatCurrency(data.data.gross_commission);
                if (taxDisplay) taxDisplay.textContent = formatCurrency(data.data.withholding_tax);
                if (netDisplay) netDisplay.textContent = formatCurrency(data.data.net_commission);
                
                // Recalculate totals
                recalculateTotals();
                
                // Show success message
                showMessage('Commission updated successfully!', 'success');
            } else {
                showMessage(data.message || 'Error updating commission', 'error');
            }
        })
        .catch(error => {
            console.error('AJAX Error:', error);
            showMessage('Network error: ' + error.message, 'error');
        });
    }

    function recalculateTotals() {
        let totalGross = 0;
        let totalTax = 0;
        let totalNet = 0;
        
        document.querySelectorAll('.gross-commission-display').forEach(display => {
            const value = parseFloat(display.textContent.replace(/[₱,]/g, '')) || 0;
            totalGross += value;
        });
        
        document.querySelectorAll('.withholding-tax-display').forEach(display => {
            const value = parseFloat(display.textContent.replace(/[₱,]/g, '')) || 0;
            totalTax += value;
        });
        
        document.querySelectorAll('.net-commission-display').forEach(display => {
            const value = parseFloat(display.textContent.replace(/[₱,]/g, '')) || 0;
            totalNet += value;
        });
        
        // Update total row displays
        const totalGrossDisplay = document.querySelector('.total-gross-commission-display');
        const totalTaxDisplay = document.querySelector('.total-tax-display');
        const totalNetDisplay = document.querySelector('.total-net-display');
        
        if (totalGrossDisplay) totalGrossDisplay.textContent = formatCurrency(totalGross);
        if (totalTaxDisplay) totalTaxDisplay.textContent = formatCurrency(totalTax);
        if (totalNetDisplay) totalNetDisplay.textContent = formatCurrency(totalNet);
        
        // Update hidden input if exists
        const totalInput = document.querySelector('.total-gross-commission-input');
        if (totalInput) totalInput.value = totalGross.toFixed(2);
    }

    function updateTotalGrossCommission(newTotalGross) {
        const csrftoken = getCookie('csrftoken');
        
        // Collect all detail IDs and commission rates
        const details = [];
        document.querySelectorAll('.editable-gross-commission').forEach(container => {
            const detailId = container.dataset.detailId;
            const rateCell = container.closest('tr').querySelector('td:nth-child(3)');
            const commissionRate = parseFloat(rateCell.textContent.replace('%', '')) || 0;
            
            if (commissionRate > 0) {
                details.push({
                    detail_id: detailId,
                    commission_rate: commissionRate
                });
            }
        });
        
        console.log('Updating total gross commission:', {
            new_total: newTotalGross,
            details: details
        });
        
        fetch('/update-total-gross-commission/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                'new_total_gross': newTotalGross,
                'details': details,
                'commission_type': 'commission3'
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                // Update all individual gross commissions
                data.data.updated_details.forEach(detail => {
                    const grossDisplay = document.querySelector(`[data-detail-id="${detail.detail_id}"] .gross-commission-display`);
                    const taxDisplay = document.querySelector(`.withholding-tax-display[data-detail-id="${detail.detail_id}"]`);
                    const netDisplay = document.querySelector(`.net-commission-display[data-detail-id="${detail.detail_id}"]`);
                    
                    if (grossDisplay) grossDisplay.textContent = formatCurrency(detail.gross_commission);
                    if (taxDisplay) taxDisplay.textContent = formatCurrency(detail.withholding_tax);
                    if (netDisplay) netDisplay.textContent = formatCurrency(detail.net_commission);
                    
                    // Update hidden input values
                    const input = document.querySelector(`[data-detail-id="${detail.detail_id}"] .gross-commission-input`);
                    if (input) input.value = detail.gross_commission.toFixed(2);
                });
                
                // Recalculate totals
                recalculateTotals();
                
                // Show success message
                showMessage('Total Gross Commission updated successfully! Redistributed among Sales Agent, Sales Supervisor, and Sales Manager.', 'success');
            } else {
                showMessage(data.message || 'Error updating total gross commission', 'error');
            }
        })
        .catch(error => {
            console.error('AJAX Error:', error);
            showMessage('Network error: ' + error.message, 'error');
        });
    }

    function showMessage(message, type) {
        // Create a temporary message element
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);
        
        // Remove after 3 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('printable-content');
        const hasSignature = container.dataset.hasSignature === 'true';
        if (hasSignature) {
            document.getElementById('attach-signature-btn').style.display = 'none';
        } else {
             document.getElementById('attach-signature-btn').style.display = 'inline-flex';
        }
        
        // Initialize gross commission editing
        document.querySelectorAll('.edit-gross-commission-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const container = this.closest('.editable-gross-commission');
                const display = container.querySelector('.gross-commission-display');
                const input = container.querySelector('.gross-commission-input');
                
                // Switch to edit mode
                display.classList.add('hidden');
                input.classList.remove('hidden');
                input.focus();
                input.select();
                this.style.display = 'none';
                
                // Handle input events
                const handleSave = () => {
                    const inputValue = input.value.trim();
                    if (!inputValue || inputValue === '') {
                        showMessage('Please enter a gross commission amount', 'error');
                        return;
                    }
                    
                    const newValue = parseFloat(inputValue);
                    if (isNaN(newValue) || newValue < 0) {
                        showMessage('Please enter a valid positive number', 'error');
                        return;
                    }
                    
                    // Round to 2 decimal places to match Decimal precision
                    const roundedValue = Math.round(newValue * 100) / 100;
                    
                    const detailId = container.dataset.detailId;
                    const commissionType = container.dataset.commissionType;
                    
                    console.log('Detail ID:', detailId, 'Commission Type:', commissionType, 'New Value:', newValue);
                    
                    updateGrossCommission(detailId, roundedValue, commissionType);
                    
                    // Switch back to display mode
                    display.classList.remove('hidden');
                    input.classList.add('hidden');
                    button.style.display = 'inline-block';
                };
                
                const handleCancel = () => {
                    // Reset input value and switch back to display mode
                    input.value = parseFloat(display.textContent.replace(/[₱,]/g, ''));
                    display.classList.remove('hidden');
                    input.classList.add('hidden');
                    button.style.display = 'inline-block';
                };
                
                // Save on Enter, cancel on Escape
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        handleSave();
                    } else if (e.key === 'Escape') {
                        handleCancel();
                    }
                });
                
                // Save on blur
                input.addEventListener('blur', handleSave);
            });
        });
        
        // Initialize total gross commission editing
        const editTotalButton = document.querySelector('.edit-total-gross-commission-btn');
        if (editTotalButton) {
            editTotalButton.addEventListener('click', function(e) {
                e.preventDefault();
                const container = this.closest('.editable-total-gross-commission');
                const display = container.querySelector('.total-gross-commission-display');
                const input = container.querySelector('.total-gross-commission-input');
                
                // Switch to edit mode
                display.classList.add('hidden');
                input.classList.remove('hidden');
                input.focus();
                input.select();
                this.style.display = 'none';
                
                // Handle input events
                const handleSave = () => {
                    const inputValue = input.value.trim();
                    if (!inputValue || inputValue === '') {
                        showMessage('Please enter a total gross commission amount', 'error');
                        // Reset and cancel
                        input.value = parseFloat(display.textContent.replace(/[₱,]/g, ''));
                        display.classList.remove('hidden');
                        input.classList.add('hidden');
                        editTotalButton.style.display = 'inline-block';
                        return;
                    }
                    
                    const newValue = parseFloat(inputValue);
                    if (isNaN(newValue) || newValue < 0) {
                        showMessage('Please enter a valid positive number', 'error');
                        // Reset and cancel
                        input.value = parseFloat(display.textContent.replace(/[₱,]/g, ''));
                        display.classList.remove('hidden');
                        input.classList.add('hidden');
                        editTotalButton.style.display = 'inline-block';
                        return;
                    }
                    
                    // Round to 2 decimal places to match Decimal precision
                    const roundedValue = Math.round(newValue * 100) / 100;
                    
                    console.log('New Total Gross Commission:', roundedValue);
                    
                    updateTotalGrossCommission(roundedValue);
                    
                    // Switch back to display mode
                    display.classList.remove('hidden');
                    input.classList.add('hidden');
                    editTotalButton.style.display = 'inline-block';
                };
                
                const handleCancel = () => {
                    // Reset input value and switch back to display mode
                    input.value = parseFloat(display.textContent.replace(/[₱,]/g, ''));
                    display.classList.remove('hidden');
                    input.classList.add('hidden');
                    editTotalButton.style.display = 'inline-block';
                };
                
                // Save on Enter, cancel on Escape
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleSave();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        handleCancel();
                    }
                });
                
                // Save on blur
                input.addEventListener('blur', handleSave, { once: true });
            });
        }
    });
</script>

{% endblock %} 