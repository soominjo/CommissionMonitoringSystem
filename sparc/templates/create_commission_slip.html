{% extends "index.html" %}

{% block content %}

{% load static %}
{% load widget_tweaks %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Commission Slip</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ============================================
           BASE STYLES & COLOR VARIABLES
           ============================================ */
        :root {
            --primary-blue: #3b82f6;
            --primary-green: #10b981;
            --primary-gradient: linear-gradient(135deg, #436cf5 0%, #3b82f6 100%);
            --light-bg: #f9fafb;
            --card-border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --focus-ring: rgba(59, 130, 246, 0.1);
        }

        /* ============================================
           RESPONSIVE TWO-COLUMN CONTAINER
           ============================================ */
        .commission-form-wrapper {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            padding: 0;
        }

        @media (min-width: 1280px) {
            .commission-form-wrapper {
                grid-template-columns: 1.5fr 1fr;
                gap: 2rem;
            }
        }

        /* ============================================
           FORM SECTION STYLES
           ============================================ */
        .form-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-section {
            background: white;
            border-radius: 1rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-section:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--card-border);
        }

        .section-icon {
            font-size: 1.25rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
        }

        .section-icon.blue {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-blue);
        }

        .section-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .section-icon.purple {
            background: rgba(147, 51, 234, 0.1);
            color: #9333ea;
        }

        .section-icon.orange {
            background: rgba(249, 115, 22, 0.1);
            color: #f97316;
        }

        /* ============================================
           FORM INPUT STYLES
           ============================================ */
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: inherit;
            background: white;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .form-input:hover,
        .form-select:hover {
            border-color: #9ca3af;
            background: #fafbfc;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--focus-ring);
            background: white;
        }

        .form-input[readonly] {
            background: #f3f4f6;
            cursor: not-allowed;
            color: #9ca3af;
        }

        /* Currency Input Styling */
        .currency-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .currency-symbol {
            position: absolute;
            left: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            pointer-events: none;
        }

        .currency-input-group .form-input {
            padding-left: 2rem;
        }

        .percent-symbol {
            position: absolute;
            right: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            pointer-events: none;
        }

        .percent-input-group .form-input {
            padding-right: 2rem;
        }

        /* Grid Layouts */
        .grid-2-col {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }

        @media (min-width: 768px) {
            .grid-2-col {
                grid-template-columns: 1fr 1fr;
            }
        }

        .grid-4-col {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }

        @media (min-width: 768px) {
            .grid-4-col {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .grid-4-col {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Conditional Field Display */
        .conditional-field {
            display: none;
        }

        .conditional-field.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           CALCULATION PANEL STYLES (RIGHT COLUMN)
           ============================================ */
        .calculation-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .calculation-panel {
            background: linear-gradient(135deg, var(--light-bg) 0%, #f0fdf4 100%);
            border-radius: 1rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        @media (min-width: 1280px) {
            .calculation-panel {
                position: sticky;
                top: 2rem;
                max-height: calc(100vh - 4rem);
                overflow-y: auto;
            }
        }

        .calculation-panel::-webkit-scrollbar {
            width: 6px;
        }

        .calculation-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .calculation-panel::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.3);
            border-radius: 3px;
        }

        .calculation-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.5);
        }

        .calculation-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--card-border);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .calculation-card:last-child {
            margin-bottom: 0;
        }

        .calculation-card .section-header {
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
        }

        .calculation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        .calculation-row:last-child {
            border-bottom: none;
        }

        .calculation-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .calculation-value {
            color: var(--text-primary);
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .calculation-row.total {
            background: rgba(59, 130, 246, 0.05);
            padding: 1rem;
            margin: 1rem -1.25rem -1.25rem -1.25rem;
            border-radius: 0 0 0.75rem 0.75rem;
            border-top: 2px solid var(--primary-blue);
        }

        .calculation-row.total .calculation-label {
            font-weight: 700;
            color: var(--text-primary);
        }

        .calculation-row.total .calculation-value {
            color: var(--primary-blue);
            font-size: 1rem;
        }

        /* ============================================
           TABLE STYLES (POSITION BREAKDOWN)
           ============================================ */
        .breakdown-table-wrapper {
            overflow-x: auto;
            border-radius: 0.75rem;
            border: 1px solid var(--card-border);
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .breakdown-table thead th {
            background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--primary-blue);
            white-space: nowrap;
        }

        .breakdown-table tbody td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            color: var(--text-secondary);
        }

        .breakdown-table tbody tr:hover {
            background: #fafbfc;
        }

        .breakdown-table tbody tr:last-child td {
            border-bottom: none;
        }

        .breakdown-table tfoot td {
            background: var(--primary-gradient);
            color: white;
            font-weight: 700;
            padding: 0.75rem;
            border-bottom: none;
        }

        .breakdown-table .amount {
            font-family: 'ari', sans-serif;
            font-weight: 600;
            text-align: right;
        }

        /* ============================================
           BUTTON STYLES
           ============================================ */
        .btn-submit {
            width: 100%;
            padding: 1rem;
            background: var(--primary-gradient);
            color: white;
            font-weight: 700;
            font-size: 1rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 1.5rem;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-back:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.05);
        }

        /* ============================================
           ERROR MESSAGE STYLES
           ============================================ */
        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .alert-error strong {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .alert-error ul {
            list-style-position: inside;
            margin-top: 0.5rem;
        }

        /* ============================================
           HEADER STYLES
           ============================================ */
        .form-header {
            background: linear-gradient(135deg, #f0fdf4 0%, #eff6ff 100%);
            border-bottom: 1px solid var(--card-border);
            padding: 2rem 1.5rem;
            border-radius: 1rem 1rem 0 0;
            text-align: center;
        }

        .form-header h1 {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .form-tabs {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .form-tab {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--card-border);
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-tab:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .form-tab.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        /* ============================================
           RESPONSIVE ADJUSTMENTS
           ============================================ */
        @media (max-width: 1279px) {
            .form-section,
            .calculation-card {
                margin-bottom: 1rem;
            }

            .btn-submit {
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 768px) {
            .form-header {
                padding: 1.5rem 1rem;
            }

            .form-header h1 {
                font-size: 1.5rem;
            }

            .section-header {
                font-size: 1rem;
            }

            .breakdown-table {
                font-size: 0.7rem;
            }

            .breakdown-table th,
            .breakdown-table td {
                padding: 0.5rem;
            }

            .grid-4-col {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .form-tabs {
                flex-direction: column;
            }

            .form-tab {
                width: 100%;
                justify-content: center;
            }

            .grid-2-col,
            .grid-4-col {
                grid-template-columns: 1fr;
            }

            .breakdown-table {
                font-size: 0.65rem;
            }
        }

        /* Legacy styles for backward compatibility */
        .commission-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 1280px) {
            .commission-grid {
                grid-template-columns: 1.5fr 1fr;
            }
        }

        /* Legacy tab styles for backward compatibility */
        .tab-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .tab-button.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .form-content {
            padding: 2rem;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            border-top: 1px solid var(--card-border);
        }

    </style>
</head>

<body>
 <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header Card with Logo -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden mb-8">
            <div class="p-6">
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div class="bg-gradient-to-br from-blue-50 to-green-50 p-3 border border-blue-200 rounded-xl flex-shrink-0">
                        <img src="{% static 'media/LOGO.png' %}" alt="Company Logo" class="w-14 h-14 object-contain">
                    </div>
                    <div class="text-center sm:text-left flex-1">
                        <h2 class="text-2xl font-bold text-gray-900 mb-1">Inner SPARC Realty Corporation</h2>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p>Main Office: Block 26 Lot 4 Phase 3 Avida Residences Sta. Catalina</p>
                            <p>Salawag, Dasmariñas, Cavite 4114 | 63917-853-4875/63999-994-3304/(046)458 0706</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Main Form Container -->
            <div class="form-container">
                <!-- Form Header -->
                <div class="form-header">
                    <h1><i class="fas fa-file-invoice mr-2"></i>Create Agent Commission Slip</h1>

                    <div class="tab-container">
                        {% if user.is_superuser or user.is_staff %}
                            <a href="{% url 'create_commission_slip' %}" class="tab-button active">
                                <i class="fas fa-user"></i> Agent
                            </a>
                            <a href="{% url 'create_commission_slip2' %}" class="tab-button">
                                <i class="fas fa-users-cog"></i> Management
                            </a>
                            <a href="{% url 'create_commission_slip3' %}" class="tab-button">
                                <i class="fas fa-user-tie"></i> Supervisor-Agent
                            </a>
                        {% elif user.profile.role == 'Sales Manager' or user.profile.role == 'Sales Supervisor' %}
                            <a href="{% url 'create_commission_slip' %}" class="tab-button active">
                                <i class="fas fa-user"></i> Agent
                            </a>
                            <a href="{% url 'create_commission_slip3' %}" class="tab-button">
                                <i class="fas fa-user-tie"></i> Supervisor-Agent
                            </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Error Messages -->
                {% if slip_form.errors %}
                    <div class="form-content">
                        <div class="error-message">
                            <strong><i class="fas fa-exclamation-circle mr-2"></i>Form Errors</strong>
                            <ul>
                                {% for field, errors in slip_form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                {% endif %}

                <!-- Form Content -->
                <div class="form-content">
                    <form method="POST" action="{% url 'create_commission_slip' %}">
                        {% csrf_token %}

                        <!-- TWO COLUMN LAYOUT -->
                        <div class="commission-form-wrapper">
                            <!-- Left Column: Form Fields -->
                            <div class="form-column">
                                
                                <!-- Project Details Section -->
                                <div class="form-section">
                                    <div class="section-header">
                                        <div class="section-icon blue"><i class="fas fa-building"></i></div>
                                        <span>Project Details</span>
                                    </div>

                                
                                        <div class="form-group">
                                            <label class="form-label">Select Agent</label>
                                            <select name="sales_agent_name" id="sales_agent_name" class="form-select" onchange="updateAgentInfo()">
                                                <option value="">Choose an agent...</option>
                                                {% for user in sales_agents %}
                                                    <option value="{{ user.get_full_name }}" data-name="{{ user.get_full_name }}" data-position="{{ user.profile.role }}">
                                                        {{ user.get_full_name }} ({{ user.profile.team }})
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <br>

                                        <div class="grid-2-col">
                                            <div class="form-group">
                                                <label class="form-label">Agent Name</label>
                                                <input type="text" id="agent_name_display" readonly class="form-input" placeholder="Auto-filled">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Position</label>
                                                <input type="text" id="position_display" readonly class="form-input" placeholder="Auto-filled">
                                            </div>
                                    

                                        <div class="form-group">
                                            <label class="form-label">Select Sales Manager</label>
                                            <select name="sales_manager_name" id="sales_manager_name" class="form-select" onchange="updateManagerInfo()">
                                                <option value="">Choose a manager...</option>
                                                {% for user in sales_managers %}
                                                    <option value="{{ user.get_full_name }}" data-name="{{ user.get_full_name }}">
                                                        {{ user.get_full_name }} ({{ user.profile.team }})
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                             <br>

                                    <div class="grid-2-col">
                                        <div class="form-group">
                                            <label class="form-label">Sales Manager Name</label>
                                            <input type="text" id="manager_name_display" readonly class="form-input" placeholder="Auto-filled">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Buyer Name</label>
                                            {{ slip_form.buyer_name|add_class:"form-input" }}
                                        </div>
                                    </div>

                                             <br>

                                    <div class="grid-2-col">
                                        <div class="form-group">
                                            <label class="form-label">Project Name</label>
                                            <select name="project_name" id="project_name" class="form-select" required>
                                                <option value="">Select a project...</option>
                                                {% for property in properties %}
                                                    <option value="{{ property.name }}">{{ property.name }}{% if property.developer %} - {{ property.developer.name }}{% endif %}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Unit ID</label>
                                            {{ slip_form.unit_id|add_class:"form-input" }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Commission Details Section -->
                                <div class="form-section">
                                    <div class="section-header">
                                        <div class="section-icon green"><i class="fas fa-calculator"></i></div>
                                        <span>Commission Details</span>
                                    </div>

                                    <div class="grid-2-col">
                                        <div class="form-group">
                                            <label class="form-label">Total Selling Price</label>
                                            <div class="currency-input-group">
                                                <span class="currency-symbol">₱</span>
                                                <input type="number" step="0.01" name="total_selling_price" id="total_selling_price" class="form-input" placeholder="0.00" required onchange="updateCommissionPreview()">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Agent Commission Rate</label>
                                            <div class="percent-input-group">
                                                <input type="number" step="0.01" name="commission_rate" id="commission_rate" value="3.00" class="form-input" required onchange="updateCommissionPreview()">
                                                <span class="percent-symbol">%</span>
                                            </div>
                                        </div>
                                    </div>

                                             <br>

                                    <div class="grid-2-col">
                                        <div class="form-group">
                                            <label class="form-label">Sales Manager Rate</label>
                                            <div class="percent-input-group">
                                                <input type="number" step="0.01" id="manager_commission_rate" name="manager_commission_rate" value="0.50" class="form-input" onchange="updateCommissionPreview()">
                                                <span class="percent-symbol">%</span>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">VAT Rate</label>
                                            <div class="percent-input-group">
                                                <input type="number" step="0.01" name="vat_rate" id="vat_rate" value="12.00" class="form-input" onchange="updateCommissionPreview()">
                                                <span class="percent-symbol">%</span>
                                            </div>
                                        </div>
                                    </div>

                                             <br>

                                    <div class="grid-2-col">
                                        <div class="form-group">
                                            <label class="form-label">Withholding Tax Rate</label>
                                            <div class="percent-input-group">
                                                <input type="number" step="0.01" name="withholding_tax_percentage" id="withholding_tax_percentage" value="10.00" class="form-input" onchange="updateCommissionPreview()">
                                                <span class="percent-symbol">%</span>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Particulars</label>
                                            <select name="particulars[]" id="particulars" class="form-select" onchange="updateFieldsVisibility(); updateCommissionPreview();">
                                                <option value="FULL COMM">FULL COMM</option>
                                                <option value="PARTIAL COMM">PARTIAL COMM</option>
                                                <option value="INCENTIVES">INCENTIVES</option>
                                                <option value="CASH ADVANCE">CASH ADVANCE</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Conditional Fields -->
                                    <div class="conditional-field partial-field">
                                        <div class="form-group">
                                            <label class="form-label">Percentage of Commission</label>
                                            <div class="percent-input-group">
                                                <input type="number" step="0.01" name="partial_percentage" id="partial_percentage" value="100" class="form-input" onchange="updateCommissionPreview()">
                                                <span class="percent-symbol">%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="conditional-field incentive-field">
                                        <div class="form-group">
                                            <label class="form-label">Incentive Amount</label>
                                            <div class="currency-input-group">
                                                <span class="currency-symbol">₱</span>
                                                <input type="number" step="0.01" name="incentive_amount" id="incentive_amount" class="form-input" placeholder="0.00" value="0" onchange="updateCommissionPreview()">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="conditional-field cash-advance-field">
                                        <div class="form-group">
                                            <label class="form-label">Cash Advance</label>
                                            <div class="currency-input-group">
                                                <span class="currency-symbol">₱</span>
                                                <input type="number" step="0.01" name="cash_advance" id="cash_advance" class="form-input" placeholder="0.00" value="0" onchange="updateCommissionPreview()">
                                            </div>
                                            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">10% tax will be automatically deducted</p>
                                        </div>
                                    </div>

                                             <br>

                                    <div class="form-group">
                                        <label class="form-label">Percentage of Particulars (Display Only)</label>
                                        <div class="percent-input-group">
                                            <input type="number" step="0.01" name="percentage_of_particulars" id="percentage_of_particulars" value="100" class="form-input">
                                            <span class="percent-symbol">%</span>
                                        </div>
                                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">For reference/printing only</p>
                                    </div>
                                </div>

                                <!-- Tax Rates Section -->
                                <div class="form-section">
                                    <div class="section-header">
                                        <div class="section-icon orange"><i class="fas fa-receipt"></i></div>
                                        <span>Tax Rates & Date</span>
                                    </div>

                                    <div class="grid-2-col">
                                        <div class="form-group">
                                            <label class="form-label">Date</label>
                                            <input type="date" name="date" id="date" class="form-input" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Agent Withholding Tax</label>
                                            <div class="percent-input-group">
                                                <input type="number" step="0.01" name="withholding_tax_rate" id="withholding_tax_rate" value="10.00" class="form-input" required onchange="updateCommissionPreview()">
                                                <span class="percent-symbol">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <br>

                                    <div class="form-group">
                                        <label class="form-label">Sales Manager Withholding Tax</label>
                                        <div class="percent-input-group">
                                            <input type="number" step="0.01" id="manager_tax_rate" name="manager_tax_rate" value="10.00" class="form-input" onchange="updateCommissionPreview()">
                                            <span class="percent-symbol">%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit" class="btn-submit">
                                    <i class="fas fa-save"></i> Save Commission Slip
                                </button>
                            </div>

                       
                        <!-- END LEFT COLUMN -->

                        <!-- RIGHT COLUMN: CALCULATION DISPLAY -->
                        <div class="calculation-column">
                                <!-- VAT Calculation Card -->
                                <div class="calculation-card">
                                    <div class="section-header">
                                        <div class="section-icon blue"><i class="fas fa-chart-line"></i></div>
                                        <span>VAT-Compliant Calculation</span>
                                    </div>

                                    <div>
                                        <div class="calculation-row">
                                            <span class="calculation-label">1. Commission Rate</span>
                                            <span class="calculation-value" id="totalCommissionRateDisplay">0.00%</span>
                                        </div>
                                        <div class="calculation-row">
                                            <span class="calculation-label">2. Gross Commission</span>
                                            <span class="calculation-value" id="totalGrossCommissionDisplay">₱0.00</span>
                                        </div>
                                        <div class="calculation-row">
                                            <span class="calculation-label">3. VATABLE Amount</span>
                                            <span class="calculation-value" id="vatableAmountDisplay">₱0.00</span>
                                        </div>
                                        <div class="calculation-row">
                                            <span class="calculation-label">4. Tax Deductions</span>
                                            <span class="calculation-value" id="totalTaxDeductionsDisplay">₱0.00</span>
                                        </div>
                                        <div class="calculation-row total">
                                            <span class="calculation-label">NET COMMISSION</span>
                                            <span class="calculation-value" id="finalNetCommissionDisplay">₱0.00</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Position Breakdown Card -->
                                <div class="calculation-card">
                                    <div class="section-header">
                                        <div class="section-icon green"><i class="fas fa-table"></i></div>
                                        <span>Position Breakdown</span>
                                    </div>

                                    <div class="breakdown-table-wrapper">
                                        <table class="breakdown-table">
                                            <thead>
                                                <tr>
                                                    <th>Position</th>
                                                    <th>Particulars</th>
                                                    <th>Rate</th>
                                                    <th>Gross</th>
                                                    <th>Tax</th>
                                                    <th>Net</th>
                                                </tr>
                                            </thead>
                                            <tbody id="previewTableBody"></tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="3">TOTAL</td>
                                                    <td class="amount" id="totalGrossCommission">₱0.00</td>
                                                    <td class="amount" id="totalTax">₱0.00</td>
                                                    <td class="amount" id="totalNetCommission">₱0.00</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </form>

                    <!-- Back Button -->
                    <div class="button-group">
                        <a href="{% url 'commission_history' %}" class="btn-back">
                            <i class="fas fa-arrow-left"></i>
                            Go Back to Commission History
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function formatCurrency(amount) {
            return amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function updateAgentInfo() {
            const select = document.getElementById('sales_agent_name');
            const selectedOption = select.options[select.selectedIndex];
            document.getElementById('agent_name_display').value = selectedOption.dataset.name || '';
            document.getElementById('position_display').value = selectedOption.dataset.position || '';
            updateCommissionPreview();
        }

        function updateManagerInfo() {
            const select = document.getElementById('sales_manager_name');
            const selectedOption = select.options[select.selectedIndex];
            document.getElementById('manager_name_display').value = selectedOption.dataset.name || '';
            updateCommissionPreview();
        }

        function updateFieldsVisibility() {
            const particularsSelect = document.getElementById('particulars');
            const selectedValue = particularsSelect.value;

            document.querySelectorAll('.conditional-field').forEach(field => {
                field.classList.remove('active');
            });

            if (selectedValue === 'INCENTIVES') {
                document.querySelector('.incentive-field').classList.add('active');
            } else if (selectedValue === 'PARTIAL COMM') {
                document.querySelector('.partial-field').classList.add('active');
            } else if (selectedValue === 'CASH ADVANCE') {
                document.querySelector('.cash-advance-field').classList.add('active');
            }

            if (selectedValue !== 'PARTIAL COMM') document.getElementById('partial_percentage').value = '100';
            if (selectedValue !== 'INCENTIVES') document.getElementById('incentive_amount').value = '0';
            if (selectedValue !== 'CASH ADVANCE') document.getElementById('cash_advance').value = '0';

            updateCommissionPreview();
        }

        function updateCommissionPreview() {
            const grossComm = parseFloat(document.getElementById('total_selling_price').value) || 0;
            const cashAdvance = parseFloat(document.getElementById('cash_advance').value) || 0;
            const particulars = document.getElementById('particulars').value;
            const partialPercentage = parseFloat(document.getElementById('partial_percentage').value) || 100;
            const incentiveAmount = parseFloat(document.getElementById('incentive_amount').value) || 0;
            
            const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
            const withholdingTaxPercentage = parseFloat(document.getElementById('withholding_tax_percentage').value) || 0;
            
            const agentTaxRate = parseFloat(document.getElementById('withholding_tax_rate').value) || 10;
            const managerTaxRate = parseFloat(document.getElementById('manager_tax_rate').value) || 10;

            const cashAdvanceTax = cashAdvance * 0.10;
            const netCashAdvance = cashAdvance - cashAdvanceTax;
            const adjustedGrossComm = grossComm - netCashAdvance;

            const positions = [
                { id: 'commission_rate', name: 'Sales Agent', taxRate: agentTaxRate, is_primary: true },
                { id: 'manager_commission_rate', name: 'Sales Manager', taxRate: managerTaxRate, is_primary: false }
            ];

            let totalCommissionRate = 0;
            positions.forEach(pos => {
                const rateInput = document.getElementById(pos.id);
                const rate = parseFloat(rateInput ? rateInput.value : 0) || 0;
                totalCommissionRate += rate;
            });

            let totalCommission = adjustedGrossComm * (totalCommissionRate / 100);
            let totalGrossCommission;

            if (particulars === 'PARTIAL COMM') {
                totalGrossCommission = totalCommission * (partialPercentage / 100);
            } else {
                totalGrossCommission = totalCommission;
            }

            if (particulars === 'INCENTIVES') {
                totalGrossCommission += incentiveAmount;
            }

            let vatableAmount = vatRate > 0 ? totalGrossCommission / (1 + vatRate / 100) : totalGrossCommission;
            let withholdingTax = withholdingTaxPercentage > 0 ? vatableAmount * (withholdingTaxPercentage / 100) : 0;
            let vatShare = vatRate > 0 ? vatableAmount * 0.108 : 0;
            const totalTaxDeductions = withholdingTax + vatShare;
            const finalNetCommission = totalGrossCommission - totalTaxDeductions;

            document.getElementById('totalCommissionRateDisplay').textContent = `${totalCommissionRate.toFixed(2)}%`;
            document.getElementById('totalGrossCommissionDisplay').textContent = `₱${formatCurrency(totalGrossCommission)}`;
            document.getElementById('vatableAmountDisplay').textContent = `₱${formatCurrency(vatableAmount)}`;
            document.getElementById('totalTaxDeductionsDisplay').textContent = `₱${formatCurrency(totalTaxDeductions)}`;
            document.getElementById('finalNetCommissionDisplay').textContent = `₱${formatCurrency(finalNetCommission)}`;

            let totalGrossCommissionSum = 0, totalWithholdingSum = 0, totalNetCommissionSum = 0;
            const tableBody = document.getElementById('previewTableBody');
            tableBody.innerHTML = '';

            positions.forEach(pos => {
                const rateInput = document.getElementById(pos.id);
                const positionRate = parseFloat(rateInput ? rateInput.value : 0) || 0;

                if (positionRate > 0) {
                    const positionGrossCommission = finalNetCommission * (positionRate / totalCommissionRate);
                    const withholdingTax = positionGrossCommission * (pos.taxRate / 100);
                    const positionNetCommission = positionGrossCommission - withholdingTax;

                    totalGrossCommissionSum += positionGrossCommission;
                    totalWithholdingSum += withholdingTax;
                    totalNetCommissionSum += positionNetCommission;

                    let particularsDisplay = particulars === 'PARTIAL COMM' ? `${partialPercentage.toFixed(0)}%` : particulars === 'INCENTIVES' ? 'INCENTIVES' : '100%';

                    const row = `
                        <tr>
                            <td>${pos.name}</td>
                            <td>${particularsDisplay}</td>
                            <td>${positionRate}%</td>
                            <td class="amount">₱${formatCurrency(positionGrossCommission)}</td>
                            <td class="amount">₱${formatCurrency(withholdingTax)}</td>
                            <td class="amount">₱${formatCurrency(positionNetCommission)}</td>
                        </tr>`;
                    tableBody.innerHTML += row;
                }
            });

            document.getElementById('totalGrossCommission').textContent = `₱${formatCurrency(totalGrossCommissionSum)}`;
            document.getElementById('totalTax').textContent = `₱${formatCurrency(totalWithholdingSum)}`;
            document.getElementById('totalNetCommission').textContent = `₱${formatCurrency(totalNetCommissionSum)}`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateFieldsVisibility();
            updateCommissionPreview();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];

            const inputs = [
                'total_selling_price', 'commission_rate', 'manager_commission_rate',
                'particulars', 'partial_percentage', 'incentive_amount',
                'cash_advance', 'withholding_tax_rate', 'manager_tax_rate',
                'vat_rate', 'withholding_tax_percentage'
            ];

            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCommissionPreview);
                }
            });

            document.getElementById('particulars').addEventListener('change', updateFieldsVisibility);
            document.getElementById('sales_agent_name').addEventListener('change', updateAgentInfo);
            document.getElementById('sales_manager_name').addEventListener('change', updateManagerInfo);
        });
    </script>
</body>

{% endblock %}
