{% extends "index.html" %}
{% block title %}Tranche History{% endblock %}
{% load static humanize %}

{% block content %}

<style>
  /* Modern color scheme */
  :root {
    --primary: #4361ee;
    --primary-light: #eef2ff;
    --secondary: #3f37c9;
    --success: #06d6a0;
    --warning: #ffd166;
    --danger: #ef476f;
    --dark: #1e293b;
    --light: #f8fafc;
    --gray: #94a3b8;
    --border: #e2e8f0;
  }
  
  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }
  
  .animate-slide-in {
    animation: slideIn 0.6s ease-out forwards;
  }
  
  /* Card styles */
  .tranche-card {
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border);
  }
  
  .tranche-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
  }
  
  /* Status badges */
  .status-badge {
    transition: all 0.3s ease;
  }
  
  /* Progress bars */
  .progress-bar {
    transition: width 0.8s ease-out;
  }
  
  /* Mobile optimizations - ENHANCED */
  @media (max-width: 768px) {
    /* Hide sidebar and navigation elements */
    .sidebar,
    .burger-menu,
    .nav-toggle,
    .mobile-menu-toggle,
    .sidebar-overlay,
    .navigation-sidebar {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      width: 0 !important;
      height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    /* Ensure main content takes full width */
    .main-content,
    .content-wrapper,
    body,
    .container {
      margin-left: 0 !important;
      padding-left: 0 !important;
      width: 100% !important;
      max-width: 100% !important;
    }
    
    /* Reset any sidebar-related margins/padding */
    .page-wrapper {
      margin-left: 0 !important;
      padding-left: 0 !important;
    }
    
    .tranche-card:hover {
      transform: none;
    }
    
    .grid-cols-1 {
      grid-template-columns: 1fr;
    }
    
    /* Mobile-specific adjustments */
    .min-h-screen {
      padding: 1rem !important;
    }
    
    .p-4.md\\:p-8 {
      padding: 1rem !important;
    }
    
    .text-2xl.md\\:text-3xl {
      font-size: 1.5rem !important;
    }
    
    .gap-8 {
      gap: 1rem !important;
    }
    
    .gap-6 {
      gap: 1rem !important;
    }
    
    .gap-4 {
      gap: 0.75rem !important;
    }
    
    /* Stack header elements vertically */
    .mb-8.flex.flex-col.md\\:flex-row {
      flex-direction: column !important;
      gap: 1rem !important;
    }
    
    /* Make filter controls stack properly */
    .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-6 {
      grid-template-columns: 1fr !important;
      gap: 1rem !important;
    }
    
    /* Responsive grid for stats */
    .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
      grid-template-columns: 1fr !important;
    }
    
    /* Responsive grid for tranche cards */
    .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3 {
      grid-template-columns: 1fr !important;
    }
    
    /* Action buttons in cards */
    .flex.flex-wrap.gap-2 {
      flex-direction: column !important;
      gap: 0.5rem !important;
    }
    
    .flex-1.text-center {
      width: 100% !important;
    }
    
    /* Search and filter adjustments */
    .flex.flex-col.md\\:flex-row.gap-4 {
      flex-direction: column !important;
      gap: 1rem !important;
    }
    
    .w-full.md\\:w-auto {
      width: 100% !important;
    }
  }
  
  /* Extra small screens */
  @media (max-width: 480px) {
    .px-5.py-3 {
      padding: 0.75rem 1rem !important;
    }
    
    .text-xl.md\\:text-2xl {
      font-size: 1.25rem !important;
    }
    
    .p-6 {
      padding: 1rem !important;
    }
    
    .rounded-2xl {
      border-radius: 1rem !important;
    }
  }
  
  /* User Autocomplete styles */
  .user-autocomplete-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.2s ease;
  }
  
  .user-autocomplete-item:hover,
  .user-autocomplete-item.highlighted {
    background-color: #f8fafc;
  }
  
  .user-autocomplete-item:last-child {
    border-bottom: none;
  }
  
  .user-autocomplete-name {
    font-weight: 600;
    color: #1e293b;
  }
  
  .user-autocomplete-details {
    font-size: 0.875rem;
    color: #64748b;
    margin-top: 2px;
  }
  
  .user-autocomplete-loading {
    padding: 12px 16px;
    text-align: center;
    color: #64748b;
    font-size: 0.875rem;
  }
</style>

<div class="min-h-screen bg-gray-50 p-4 md:p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-history text-blue-500 mr-3"></i>
          Account Summary Dashboard
        </h1>
        <p class="text-gray-600 mt-2">Track and manage all account records</p>
      </div>
      
      <div class="flex flex-col md:flex-row items-center gap-4">
        <!-- Total Units Card -->
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-medium text-blue-600">Total Units</h3>
              <p class="text-2xl font-bold text-blue-600 mt-1">{{ total_records }}</p>
            </div>
          </div>
        
        {% if user.is_superuser or user.is_staff %}
        <a href="{% url 'tranches' %}" 
           class="inline-flex items-center px-5 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md transition-all duration-300">
          <i class="fas fa-plus-circle mr-2"></i> 
          Create Tranche
        </a>
        {% endif %}
      </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white gradient-bg shadow-lg border-l-4 border-green-500 p-6 rounded-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium text-gray-600">Total Account Value</h3>
            <p class="text-3xl font-bold text-green-600 mt-2">₱{{ total_contract_value|floatformat:2|intcomma }}</p>
          </div>
          <div class="bg-green-100 p-3 rounded-full">
            <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white gradient-bg shadow-lg border-l-4 border-blue-500 p-6 rounded-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium text-gray-600">Total Gross Commission</h3>
            <p class="text-3xl font-bold text-blue-600 mt-2">₱{{ total_gross_commission|floatformat:2|intcomma }}</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-full">
            <i class="fas fa-chart-line text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white gradient-bg shadow-lg border-l-4 border-orange-500 p-6 rounded-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium text-gray-600">Total Net Commission</h3>
            <p class="text-3xl font-bold text-orange-600 mt-2">₱{{ total_net_commission|floatformat:2|intcomma }}</p>
          </div>
          <div class="bg-orange-100 p-3 rounded-full">
            <i class="fas fa-coins text-orange-600 text-xl"></i>
          </div>
        </div>
      </div>
      
      <div class="bg-white gradient-bg shadow-lg border-l-4 border-yellow-500 p-6 rounded-2xl">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-medium text-gray-600">Active Units</h3>
            <p class="text-3xl font-bold text-yellow-600 mt-2">{{ active_tranches }}</p>
          </div>
          <div class="bg-yellow-100 p-3 rounded-full">
            <i class="fas fa-sync-alt text-yellow-600 text-xl"></i>
          </div>
        </div>
      </div>

    </div>

    
    
    <!-- Filters -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Filters</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
        <!-- Year Filter -->
        <div>
          <label for="yearFilter" class="block text-sm font-medium text-gray-700 mb-2">Year</label>
          <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Years</option>
            {% for year in available_years %}
              <option value="{{ year }}" {% if year|stringformat:"s" == selected_year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Month Filter -->
        <div>
          <label for="monthFilter" class="block text-sm font-medium text-gray-700 mb-2">Month</label>
          <select id="monthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Months</option>
            {% for month_num, month_name in available_months %}
              <option value="{{ month_num }}" {% if month_num|stringformat:"s" == selected_month %}selected{% endif %}>{{ month_name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Developer Filter -->
        <div>
          <label for="developerFilter" class="block text-sm font-medium text-gray-700 mb-2">Developer</label>
          <select id="developerFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Developers</option>
            {% for developer in all_developers %}
              <option value="{{ developer }}" {% if developer == selected_developer %}selected{% endif %}>{{ developer }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Property Filter -->
        <div>
          <label for="propertyFilter" class="block text-sm font-medium text-gray-700 mb-2">Property</label>
          <select id="propertyFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Properties</option>
            {% for property in all_properties %}
              <option value="{{ property }}" {% if property == selected_property %}selected{% endif %}>{{ property }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Team Filter (Only for superusers) -->
        {% if user.is_superuser %}
        <div>
          <label for="teamFilter" class="block text-sm font-medium text-gray-700 mb-2">Team</label>
          <select id="teamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Teams</option>
            {% for team in all_teams %}
              <option value="{{ team.name }}" {% if team.name == selected_team %}selected{% endif %}>{{ team.display_name|default:team.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- User Filter with Autocomplete (Only for superusers) -->
        {% if user.is_superuser %}
        <div class="relative">
          <label for="userFilter" class="block text-sm font-medium text-gray-700 mb-2">User</label>
          <div class="relative">
            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 z-10">
              <i class="fas fa-user text-gray-400"></i>
            </div>
            <input type="text" 
                   id="userFilter" 
                   placeholder="Search for user..."
                   value="{% if selected_user_name %}{{ selected_user_name }}{% endif %}"
                   autocomplete="off"
                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <input type="hidden" id="userFilterId" value="{{ selected_user }}">
            
            <!-- Autocomplete Dropdown -->
            <div id="userAutocompleteDropdown" 
                 class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden">
              <!-- Suggestions will be populated here -->
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Search -->
      <div class="flex flex-col md:flex-row gap-4 items-center">
        <div class="relative w-full">
          <input type="text" id="searchInput" placeholder="Search by project, agent, or buyer..." 
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
            <i class="fas fa-search"></i>
          </div>
        </div>
        <div class="flex gap-3 w-full md:w-auto">
          <select id="statusFilter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Status</option>
            <option value="active_pending" {% if selected_status == "active_pending" %}selected{% endif %}>Active / Pending</option>
            <option value="completed" {% if selected_status == "completed" %}selected{% endif %}>Completed</option>
          </select>
          <select id="dateFilter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
          </select>
        </div>
      </div>
      
      <!-- Custom Date Range -->
      <div class="flex flex-col md:flex-row gap-4 items-center mt-4">
        <div class="flex gap-3 w-full">
          <div class="flex-1"> 
            <input type="date" id="dateFrom" name="date_from" value="{{ selected_date_from }}"
                   placeholder="From Date"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
          </div>
          <div class="flex-1">
            <input type="date" id="dateTo" name="date_to" value="{{ selected_date_to }}"
                   placeholder="To Date"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
          </div>
          <button type="button" id="applyDateRange" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 whitespace-nowrap">
            Apply
          </button>
          <button type="button" id="clearDateRange" 
                  class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors duration-200 whitespace-nowrap">
            Clear
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tranche Cards -->
    <div class="mb-12">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-file-invoice-dollar text-blue-500 mr-3"></i>
          All Tranche Records
        </h2>
        <span class="text-sm text-gray-500">
          {{ page_obj.paginator.count }} record{{ page_obj.paginator.count|pluralize }}
        </span>
      </div>
      
      {% if page_obj %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for stats in page_obj %}
        <div class="tranche-card bg-white rounded-2xl overflow-hidden animate-fade-in" 
             data-project="{{ stats.record.project_name|lower }}" 
             data-agent="{{ stats.record.agent_name|lower }}"
             data-buyer="{{ stats.record.buyer_name|lower }}"
             data-status="{{ stats.status|lower }}"
             data-date="{{ stats.record.reservation_date|date:'Y-m-d' }}">
          <div class="p-6">
            <!-- Project Header -->
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="font-bold text-gray-800 text-lg">{{ stats.record.project_name }}</h3>
                <p class="text-sm text-gray-600">Phase {{ stats.record.phase }}</p>
              </div>
              <div class="text-sm text-gray-500">
                {{ stats.record.reservation_date|date:"M d, Y" }}
              </div>
            </div>
            
            <!-- Agent & Buyer -->
            <div class="flex items-center mb-4">
              <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                {{ stats.record.agent_name|first }}
              </div>
              <div class="ml-3">
                <p class="font-medium text-gray-800">{{ stats.record.agent_name }}</p>
                <p class="text-xs text-gray-600">Unit {{ stats.record.unit_id }}</p>
              </div>
            </div>
            
            <div class="mb-4">
              <p class="text-sm text-gray-700 mb-1">Buyer</p>
              <p class="font-medium text-gray-800">{{ stats.record.buyer_name }}</p>
            </div>
            
            <!-- Contract Price -->
            <div class="mb-4">
              <p class="text-sm text-gray-700 mb-1">Contract Price</p>
              <p class="text-xl font-bold text-gray-800">₱ {{ stats.record.total_contract_price|floatformat:2|intcomma }}</p>
            </div>
            
            <!-- Progress -->
            <div class="mb-6">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium text-gray-700">Progress</span>
                <span class="text-xs font-semibold 
                  {% if stats.status == 'Completed' %}text-green-600
                  {% elif stats.status == 'In Progress' %}text-yellow-600
                  {% else %}text-red-600{% endif %}">
                  {{ stats.received_payments }}/{{ stats.total_payments }}
                </span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div class="progress-bar h-full rounded-full
                  {% if stats.status == 'Completed' %}bg-green-500
                  {% elif stats.status == 'In Progress' %}bg-yellow-500
                  {% else %}bg-red-500{% endif %}" 
                  style="width: {{ stats.completion_percentage }}%">
                </div>
              </div>
              <div class="flex justify-between mt-1">
                <span class="text-xs text-gray-500">Started</span>
                <span class="text-xs font-semibold 
                  {% if stats.status == 'Completed' %}text-green-600
                  {% elif stats.status == 'In Progress' %}text-yellow-600
                  {% else %}text-red-600{% endif %}">
                  {{ stats.status }}
                </span>
              </div>
            </div>
            
            <!-- Actions -->
            <div class="flex flex-wrap gap-2">
              <a href="{% url 'view_tranche' stats.record.id %}" 
                 class="flex-1 text-center px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition">
                <i class="fas fa-eye mr-1"></i> <br> Details
              </a>
     
              {% if user.is_superuser or user.is_staff %}
              <a href="{% url 'edit_tranche' stats.record.id %}" 
                 class="flex-1 text-center px-4 py-2 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded-lg transition">
                <i class="fas fa-edit mr-1"></i> <br> Edit
              </a>
              
              <form method="POST" action="{% url 'delete_tranche' stats.record.id %}" class="flex-1">
                {% csrf_token %}
                <button type="submit" 
                        onclick="return confirm('Are you sure you want to delete this tranche record?')" 
                        class="w-full px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition">
                  <i class="fas fa-trash-alt mr-1"></i> Delete
                </button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Pagination -->
      {% if page_obj.paginator.num_pages > 1 %}
      <div class="mt-8 flex justify-center">
        <div class="flex items-center space-x-2">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if selected_developer %}&developer={{ selected_developer }}{% endif %}{% if selected_property %}&property={{ selected_property }}{% endif %}{% if selected_month %}&month={{ selected_month }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}{% if selected_user %}&user={{ selected_user }}{% endif %}{% if selected_team %}&team={{ selected_team }}{% endif %}{% if selected_date_from %}&date_from={{ selected_date_from }}{% endif %}{% if selected_date_to %}&date_to={{ selected_date_to }}{% endif %}" 
             class="px-4 py-2 bg-white border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition">
            <i class="fas fa-chevron-left mr-1"></i> Previous
          </a>
          {% endif %}
          
          <span class="px-4 py-2 bg-blue-100 text-blue-800 font-medium rounded-lg">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
          
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if selected_developer %}&developer={{ selected_developer }}{% endif %}{% if selected_property %}&property={{ selected_property }}{% endif %}{% if selected_month %}&month={{ selected_month }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}{% if selected_user %}&user={{ selected_user }}{% endif %}{% if selected_team %}&team={{ selected_team }}{% endif %}{% if selected_date_from %}&date_from={{ selected_date_from }}{% endif %}{% if selected_date_to %}&date_to={{ selected_date_to }}{% endif %}"
             class="px-4 py-2 bg-white border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-100 transition">
            Next <i class="fas fa-chevron-right ml-1"></i>
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
      {% else %}
      <div class="bg-white rounded-2xl p-8 text-center border border-gray-200 shadow-sm">
        <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
          <i class="fas fa-file-alt text-blue-500 text-2xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-800 mb-2">No account records found</h3>
        <p class="text-gray-600">Create your first account record to get started</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Initialize search and filter functionality
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const dateFilter = document.getElementById('dateFilter');
  const yearFilter = document.getElementById('yearFilter');
  const monthFilter = document.getElementById('monthFilter');
  const developerFilter = document.getElementById('developerFilter');
  const propertyFilter = document.getElementById('propertyFilter');
  const userFilter = document.getElementById('userFilter');
  const teamFilter = document.getElementById('teamFilter');
  const dateFromInput = document.getElementById('dateFrom');
  const dateToInput = document.getElementById('dateTo');
  const applyDateRangeBtn = document.getElementById('applyDateRange');
  const clearDateRangeBtn = document.getElementById('clearDateRange');
  const trancheCards = document.querySelectorAll('.tranche-card');
  
  // Function to update URL parameters and reload page
  function updateFiltersAndReload() {
    const params = new URLSearchParams(window.location.search);
    
    // Update URL parameters with current filter values
    const year = yearFilter ? yearFilter.value : '';
    const month = monthFilter ? monthFilter.value : '';
    const developer = developerFilter ? developerFilter.value : '';
    const property = propertyFilter ? propertyFilter.value : '';
    const user = userFilter ? userFilter.value : '';
    const team = teamFilter ? teamFilter.value : '';
    const dateFrom = dateFromInput ? dateFromInput.value : '';
    const dateTo = dateToInput ? dateToInput.value : '';
    
    // Set or remove parameters
    if (year) params.set('year', year);
    else params.delete('year');
    
    if (month) params.set('month', month);
    else params.delete('month');
    
    if (developer) params.set('developer', developer);
    else params.delete('developer');
    
    if (property) params.set('property', property);
    else params.delete('property');
    
    if (user) params.set('user', user);
    else params.delete('user');
    
    if (team) params.set('team', team);
    else params.delete('team');
    
    if (dateFrom) params.set('date_from', dateFrom);
    else params.delete('date_from');
    
    if (dateTo) params.set('date_to', dateTo);
    else params.delete('date_to');
    
    // Reset to page 1 when filters change
    params.delete('page');
    
    // Reload page with new parameters
    window.location.search = params.toString();
  }
  
  // Add event listeners for filter dropdowns
  if (yearFilter) yearFilter.addEventListener('change', updateFiltersAndReload);
  if (monthFilter) monthFilter.addEventListener('change', updateFiltersAndReload);
  if (developerFilter) developerFilter.addEventListener('change', updateFiltersAndReload);
  if (propertyFilter) propertyFilter.addEventListener('change', updateFiltersAndReload);
  if (userFilter) userFilter.addEventListener('change', updateFiltersAndReload);
  if (teamFilter) teamFilter.addEventListener('change', updateFiltersAndReload);
  
  // Add event listeners for custom date range
  if (applyDateRangeBtn) {
    applyDateRangeBtn.addEventListener('click', function() {
      // Validate date range
      const fromDate = dateFromInput ? dateFromInput.value : '';
      const toDate = dateToInput ? dateToInput.value : '';
      
      if (fromDate && toDate && fromDate > toDate) {
        alert('From date cannot be later than To date.');
        return;
      }
      
      updateFiltersAndReload();
    });
  }
  
  if (clearDateRangeBtn) {
    clearDateRangeBtn.addEventListener('click', function() {
      if (dateFromInput) dateFromInput.value = '';
      if (dateToInput) dateToInput.value = '';
      updateFiltersAndReload();
    });
  }
  
  // Filter function for search and status (client-side filtering)
  function filterTranches() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const dateValue = dateFilter ? dateFilter.value : '';
    
    trancheCards.forEach(card => {
      const project = card.dataset.project;
      const agent = card.dataset.agent;
      const buyer = card.dataset.buyer;
      const status = card.dataset.status;
      const date = card.dataset.date;
      
      let showCard = true;
      
      // Search filter
      if (searchTerm) {
        showCard = project.includes(searchTerm) || 
                   agent.includes(searchTerm) || 
                   buyer.includes(searchTerm);
      }
      
      // Status filter
      if (statusValue && showCard) {
        if (statusValue === 'active_pending') {
          showCard = status !== 'completed';
        } else if (statusValue === 'completed') {
          showCard = status === 'completed';
        }
      }
      
      // Date filter
      if (dateValue && showCard) {
        const today = new Date();
        const trancheDate = new Date(date);
        
        switch(dateValue) {
          case 'today':
            showCard = trancheDate.toDateString() === today.toDateString();
            break;
          case 'week':
            const weekAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
            showCard = trancheDate >= weekAgo;
            break;
          case 'month':
            showCard = trancheDate.getMonth() === today.getMonth() && 
                      trancheDate.getFullYear() === today.getFullYear();
            break;
          case 'year':
            showCard = trancheDate.getFullYear() === today.getFullYear();
            break;
        }
      }
      
      card.style.display = showCard ? 'block' : 'none';
    });
  }
  
  // Add event listeners for search and status filters
  if (searchInput) searchInput.addEventListener('input', filterTranches);
  if (statusFilter) statusFilter.addEventListener('change', filterTranches);
  if (dateFilter) dateFilter.addEventListener('change', filterTranches);
  
  // Animate progress bars
  document.querySelectorAll('.progress-bar').forEach(bar => {
    setTimeout(() => {
      bar.style.width = bar.style.width; // Trigger animation
    }, 150);
  });
  
  // Initialize with any URL parameters for search and status
  const urlParams = new URLSearchParams(window.location.search);
  const searchParam = urlParams.get('search');
  const statusParam = urlParams.get('status');
  const dateParam = urlParams.get('date');
  const dateFromParam = urlParams.get('date_from');
  const dateToParam = urlParams.get('date_to');
  
  if (searchParam && searchInput) {
    searchInput.value = searchParam;
  }
  
  if (statusParam && statusFilter) {
    statusFilter.value = statusParam;
  }
  
  if (dateParam && dateFilter) {
    dateFilter.value = dateParam;
  }
  
  if (dateFromParam && dateFromInput) {
    dateFromInput.value = dateFromParam;
  }
  
  if (dateToParam && dateToInput) {
    dateToInput.value = dateToParam;
  }
  
  filterTranches();
  
  // User Autocomplete functionality
  let userAutocompleteTimeout;
  let currentUserHighlightIndex = -1;

  function showUserAutocomplete(query) {
    const dropdown = document.getElementById('userAutocompleteDropdown');
    
    if (query.length < 1) {
      dropdown.classList.add('hidden');
      return;
    }
    
    // Show loading
    dropdown.innerHTML = '<div class="user-autocomplete-loading"><i class="fas fa-spinner fa-spin mr-2"></i>Searching...</div>';
    dropdown.classList.remove('hidden');
    
    // Fetch suggestions
    fetch(`{% url 'user_filter_autocomplete' %}?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        displayUserSuggestions(data.suggestions);
      })
      .catch(error => {
        console.error('User autocomplete error:', error);
        dropdown.classList.add('hidden');
      });
  }

  function displayUserSuggestions(suggestions) {
    const dropdown = document.getElementById('userAutocompleteDropdown');
    currentUserHighlightIndex = -1;
    
    if (suggestions.length === 0) {
      dropdown.innerHTML = '<div class="user-autocomplete-loading">No users found</div>';
      return;
    }
    
    const html = suggestions.map((suggestion, index) => `
      <div class="user-autocomplete-item" data-index="${index}" data-user-id="${suggestion.id}" data-full-name="${suggestion.full_name}">
        <div class="user-autocomplete-name">${suggestion.full_name}</div>
        <div class="user-autocomplete-details">${suggestion.role} • ${suggestion.team}</div>
      </div>
    `).join('');
    
    dropdown.innerHTML = html;
    
    // Add click listeners
    dropdown.querySelectorAll('.user-autocomplete-item').forEach(item => {
      item.addEventListener('click', function() {
        selectUserSuggestion(this.dataset.userId, this.dataset.fullName);
      });
    });
  }

  function selectUserSuggestion(userId, fullName) {
    document.getElementById('userFilter').value = fullName;
    document.getElementById('userFilterId').value = userId;
    document.getElementById('userAutocompleteDropdown').classList.add('hidden');
    applyUserFilter();
  }

  function highlightUserSuggestion(direction) {
    const items = document.querySelectorAll('.user-autocomplete-item');
    if (items.length === 0) return;
    
    // Remove current highlight
    if (currentUserHighlightIndex >= 0) {
      items[currentUserHighlightIndex].classList.remove('highlighted');
    }
    
    // Update index
    if (direction === 'down') {
      currentUserHighlightIndex = (currentUserHighlightIndex + 1) % items.length;
    } else if (direction === 'up') {
      currentUserHighlightIndex = currentUserHighlightIndex <= 0 ? items.length - 1 : currentUserHighlightIndex - 1;
    }
    
    // Add new highlight
    items[currentUserHighlightIndex].classList.add('highlighted');
  }

  function applyUserFilter() {
    const url = new URL(window.location);
    const userId = document.getElementById('userFilterId').value;
    
    if (userId) {
      url.searchParams.set('user', userId);
    } else {
      url.searchParams.delete('user');
    }
    
    // Remove page parameter to start from page 1
    url.searchParams.delete('page');
    
    // Redirect with new filter
    window.location.href = url.toString();
  }

  // User autocomplete event listeners
  const userFilterInput = document.getElementById('userFilter');
  const userFilterIdInput = document.getElementById('userFilterId');
  
  if (userFilterInput) {
    userFilterInput.addEventListener('input', function() {
      clearTimeout(userAutocompleteTimeout);
      const query = this.value.trim();
      
      // Clear the hidden ID when typing
      if (userFilterIdInput) userFilterIdInput.value = '';
      
      userAutocompleteTimeout = setTimeout(() => {
        showUserAutocomplete(query);
      }, 300);
    });

    userFilterInput.addEventListener('keydown', function(event) {
      const dropdown = document.getElementById('userAutocompleteDropdown');
      
      if (!dropdown.classList.contains('hidden')) {
        if (event.key === 'ArrowDown') {
          event.preventDefault();
          highlightUserSuggestion('down');
        } else if (event.key === 'ArrowUp') {
          event.preventDefault();
          highlightUserSuggestion('up');
        } else if (event.key === 'Enter') {
          event.preventDefault();
          const highlighted = document.querySelector('.user-autocomplete-item.highlighted');
          if (highlighted) {
            selectUserSuggestion(highlighted.dataset.userId, highlighted.dataset.fullName);
          } else {
            applyUserFilter();
          }
        } else if (event.key === 'Escape') {
          dropdown.classList.add('hidden');
        }
      } else if (event.key === 'Enter') {
        applyUserFilter();
      }
    });
  }

  // Hide autocomplete when clicking outside
  document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('userAutocompleteDropdown');
    if (userFilterInput && dropdown && !userFilterInput.contains(event.target) && !dropdown.contains(event.target)) {
      dropdown.classList.add('hidden');
    }
  });
});
</script>

{% endblock %}
